---
title: "BERLIN"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{BERLIN_Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{css, echo=FALSE}
    body .main-container {
      max-width: 1280px !important;
      width: 1280px !important;
    }
    body {
      max-width: 1280px !important;
    }
```


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Basic Exploration of single-cell RNAseq data and LINeages

# Introduction

The utilization of single-cell RNA sequencing (scRNA-seq) has emerged as a robust approach to examining the complexities of cellular heterogeneity and genetic expression with distinctive resolution. However, analyzing scRNAseq data can be complex and requires a standardized approach. This protocol outlines a comprehensive workflow for analyzing scRNAseq data using R and the Seurat package, along with other tools like SeuratDisk, patchwork, dplyr, Single R, and Celldex. The protocol covers essential steps such as quality control, normalization, data scaling, dimension reduction, clustering, and automated cell annotation. Following this protocol allows bioinformaticians and researchers to effectively analyze scRNAseq data, identify distinct cell populations, and gain valuable insights into cellular dynamics and functions. The output files generated by this protocol, including metadata, H5 Seurat files, cell sub population metadata, and ISCVA-compliant files, facilitate downstream analyses and enable integration with other analysis and visualization tools. This protocol provides a standardized and reproducible framework for scRNAseq analysis.

# Installation

BERLIN is available to install from GitHub via `devtools`. Currently, it does require the pre-installation of the `celldex` package from Bioconductor. This is a package used to obtain databases for single cell annotation.

```{r message=FALSE, warning=FALSE}
#install.packages("devtools")
#install.packages("BiocManager")
#install.packages("remotes")

#BiocManager::install("celldex")
#remotes::install_github("mojaveazure/seurat-disk")
#devtools::install_github("shawlab-moffitt/BERLIN")

library("SeuratDisk")
library("DT")
library("scGate")
library("BERLIN")
```

# Data Input

The starting data for the BERLIN workflow can be input in two different methods, a Seurat object or a count matrix with an optional meta data table.

```{r message=FALSE, warning=FALSE}
h5seruat_file <- "~/R/Projects/BERLIN/vignettes/GSE162631_corrected_merged_both_macrophages_peri_h5.h5seurat"
seruat_obj <- SeuratDisk::LoadH5Seurat(h5seruat_file, assays = "RNA")
print(seruat_obj)
```

# Quality Control

<center>

![BERLIN QC Workflow](berlin_qc.PNG){width="100%"}

</center>

```{r message=FALSE, warning=FALSE}
obj_qc <- berlin_qc(object = seruat_obj)
print(obj_qc)
```

# Annotation

<center>

![BERLIN Annotation Workflow](berlin_anno.PNG){width="100%"}

</center>

```{r message=FALSE, warning=FALSE}
obj_qc_anno <- berlin_annotate(object = obj_qc,
                               verbose = FALSE)
```

# Dimension Reduction and Clustering

<center>

![BERLIN Clustering Workflow](berlin_cluster.PNG){width="100%"}

</center>

```{r message=FALSE, warning=FALSE}
obj_qc_anno_clpr <- berlin_cluster(object = obj_qc_anno)
print(obj_qc_anno_clpr)
```

# Differential Gene Exprssion

<center>

![BERLIN Cluster DGE Workflow](berlin_cluster_deg.PNG){width="100%"}

</center>

```{r message=FALSE, warning=FALSE}
cluster_deg <- berlin_cluster_deg(object = obj_qc_anno_clpr)
class(cluster_deg)

# List of FindMarkers results
class(cluster_deg$Cluster_Markers_DEG)
head(cluster_deg$Cluster_Markers_DEG[[1]])

# Geneset of significant up and downregulated FindMarkers results
class(cluster_deg$Cluster_Markers_Geneset)
head(cluster_deg$Cluster_Markers_Geneset)
```

# scType

<center>

![BERLIN scType Workflow](berlin_sctype.PNG){width="100%"}

</center>

## BERLIN Geneset Database

```{r message=FALSE, warning=FALSE}
# Available Geneset Options
ScType_genesets()

scType_gs1 <- "immune"
data(list = paste0("ScType_immune_system_PosIndicator_Geneset_DB"), package = "BERLIN")
head(ScType_immune_system_PosIndicator_Geneset_DB,3)
data(list = paste0("ScType_immune_system_PosIndicator_Geneset_DB"), package = "BERLIN")
head(ScType_immune_system_PosIndicator_Geneset_DB,3)

scType_gs2 <- "brain"
data(list = paste0("ScType_",tolower(scType_gs2),"_PosIndicator_Geneset_DB"), package = "BERLIN")
head(ScType_brain_PosIndicator_Geneset_DB,3)

```

## Running BERLIN Provided Geneset

```{r message=FALSE, warning=FALSE}
sctype_brain_res <- berlin_sctype(object = obj_qc_anno_clpr,
                                  geneset = "brain")

DT::datatable(head(sctype_brain_res,c(20,20)),
              options = list(lengthMenu = c(5,10, 20, 100, 1000),
                             pageLength = 5,
                             scrollX = T))
```

## Running Positive and Negative Indicator Genesets

```{r message=FALSE, warning=FALSE}
sctype_immune_res <- berlin_sctype(object = obj_qc_anno_clpr,
                                   pos_geneset = ScType_immune_system_PosIndicator_Geneset_DB,
                                   neg_geneset = ScType_immune_system_PosIndicator_Geneset_DB)

# scType enrichment score matrix
DT::datatable(head(sctype_immune_res,c(20,20)),
              options = list(lengthMenu = c(5,10, 20, 100, 1000),
                             pageLength = 5,
                             scrollX = T))
```

# scGate

<center>

![BERLIN scGate Workflow](berlin_scgate.PNG){width="100%"}

</center>

## Generate Custom scGate Model

### Example Model Parameters Input

```{r message=FALSE, warning=FALSE}
model_param <- read.delim("scGAte_Params_test_noTcell_20241023.txt", sep = '\t', header = T)

DT::datatable(model_param,
              options = list(lengthMenu = c(5,10, 20, 100, 1000),
                             pageLength = 5,
                             scrollX = T))
```

### Model Generation

```{r message=FALSE, warning=FALSE}
scGate_model_noTcell <- berlin_scgate_model(params = model_param)

# Model composed of multiple celltypes
class(scGate_model_noTcell)

# Example celltype data
DT::datatable(scGate_model_noTcell$Macrophage,
              options = list(lengthMenu = c(5,10, 20, 100, 1000),
                             pageLength = 5,
                             scrollX = T))
```

### Run Single scGate Model

```{r message=FALSE, warning=FALSE}
obj_qc_anno_clpr_scg_singlemod <- berlin_scgate(object = obj_qc_anno_clpr,
                                                model = scGate_model_noTcell,
                                                model_name = "noTcell_model")

# scGate Results appended to metadata
scg_singlemod_meta <- obj_qc_anno_clpr_scg_singlemod[[]]
DT::datatable(scg_singlemod_meta,
                  options = list(lengthMenu = c(5,10, 20, 100, 1000),
                                 pageLength = 5,
                                 scrollX = T))
```

## Use scGate Model Database

### Obtain multiple models from scGate

```{r message=FALSE, warning=FALSE}
scGate_models_DB <- get_scGateDB()
class(scGate_models_DB)
names(scGate_models_DB)

scGate_models_DB_human <- scGate_models_DB[["human"]]
class(scGate_models_DB_human)
names(scGate_models_DB_human)

scGate_models_DB_human_sub <- scGate_models_DB_human[c("CD8_TIL","PBMC")]
class(scGate_models_DB_human_sub[["CD8_TIL"]])
names(scGate_models_DB_human_sub[["CD8_TIL"]])
head(scGate_models_DB_human_sub[["CD8_TIL"]][[1]])
```

### Run Multi-Model scGate Analysis

```{r message=FALSE, warning=FALSE}
obj_qc_anno_clpr_scg_multimod <- berlin_scgate(object = obj_qc_anno_clpr,
                                               model = scGate_models_DB_human_sub)

# scGate Results appended to metadata
scg_multimod_meta <- obj_qc_anno_clpr_scg_multimod[[]]
DT::datatable(scg_multimod_meta,
              options = list(lengthMenu = c(5,10, 20, 100, 1000),
                             pageLength = 5,
                             scrollX = T))
```

## Summarize scGate Results

<center>

![BERLIN scGate Summary Workflow](berlin_scgate_summ.PNG){width="100%"}

</center>

### Summarize Single Model Results

```{r message=FALSE, warning=FALSE}
scg_simpmod_summ <- berlin_scgate_summarize(obj_qc_anno_clpr_scg_singlemod,
                                            celltype_col = "scGate_noTcell_model_Celltype",
                                            cluster_col = "seurat_clusters")
# scGate Summary
DT::datatable(scg_simpmod_summ,
              options = list(lengthMenu = c(5,10, 20, 100, 1000),
                             pageLength = 5,
                             scrollX = T))
```

### Summarize Multi-Model Results

```{r message=FALSE, warning=FALSE}
scg_mulmod_summ <- berlin_scgate_summarize(obj_qc_anno_clpr_scg_multimod)

# scGate Summary
DT::datatable(scg_mulmod_summ,
              options = list(lengthMenu = c(5,10, 20, 100, 1000),
                             pageLength = 5,
                             scrollX = T))

```
